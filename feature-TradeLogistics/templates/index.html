<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trading Strategy Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f6fafb; margin: 0; padding: 0; }
        .metrics-bar { display: flex; justify-content: center; gap: 2rem; margin: 2rem 0 1rem 0; }
        .metric-box { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 1rem 2rem; min-width: 160px; text-align: center; font-size: 0.95rem; }
        .metric-label { color: #888; font-size: 0.85em; }
        .metric-value { font-size: 1.5em; font-weight: bold; margin-top: 0.2em; }
        .section { max-width: 1200px; margin: 0 auto 2rem auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 1.5rem; }
        .section-title { font-size: 1.2em; margin-bottom: 1rem; color: #333; }
        .ws-symbols { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .ws-symbol { background: #e3f2fd; color: #1976d2; border-radius: 4px; padding: 0.3em 0.8em; font-size: 1em; }
        .strategies-scroll { display: flex; flex-wrap: nowrap; align-items: stretch; overflow-x: auto; padding-bottom: 1rem; }
        .strategy-card { display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; vertical-align: top; background: #f9f9fb; border-radius: 8px; box-shadow: 0 1px 4px #0001; margin-right: 1rem; width: 340px; min-height: 340px; max-height: 340px; padding: 1rem; margin-bottom: 1rem; position: relative; box-sizing: border-box; }
        .strategy-header { display: flex; justify-content: space-between; align-items: center; }
        .strategy-name { font-weight: bold; font-size: 1.1em; }
        .toggle-btn { cursor: pointer; background: #eee; border: none; border-radius: 12px; padding: 0.2em 1em; font-size: 0.95em; margin-left: 0.5em; position: relative; overflow: hidden; transition: background 0.2s, color 0.2s, transform 0.18s cubic-bezier(.4,2,.6,1), box-shadow 0.18s; box-shadow: 0 1px 2px #0001; }
        .toggle-btn.active { background: #b2f2bb; color: #155724; }
        .toggle-btn.inactive { background: #ffe0e0; color: #721c24; }
        .toggle-btn .toggle-label { position: relative; z-index: 1; display: block; transition: none; }
        .toggle-btn .toggle-alt { display: none; }
        .toggle-btn:hover { transform: scale(1.12); box-shadow: 0 4px 16px #0002; }
        .strategy-description { color: #555; font-size: 0.98em; margin: 0.5em 0 0.5em 0; word-break: break-word; white-space: pre-line; overflow-wrap: break-word; max-width: 95%; flex: 0 0 auto; }
        .strategy-card .metrics-section { margin-top: auto; display: flex; flex-direction: column; justify-content: flex-end; }
        .metrics-label { font-size: 0.93em; color: #888; margin-bottom: 0.2em; margin-top: 0.3em; }
        .metrics-scroll-box { display: flex; overflow-x: auto; gap: 0.5em; background: #f1f3f6; border-radius: 6px; padding: 0.4em 0.2em; margin-bottom: 0.4em; }
        .metric-pill { height: 2.1em; display: flex; align-items: center; border-radius: 6px; padding: 0 1em; font-size: 0.97em; text-align: center; margin-right: 0.2em; box-shadow: 0 1px 2px #0001; color: #fff; font-weight: 500; white-space: nowrap; }
        .metric-pill.recs { background: #1976d2; }
        .metric-pill.articles { background: #00bcd4; }
        .metric-pill.buy { background: #43a047; }
        .metric-pill.sell { background: #e53935; }
        .metric-pill.success { background: #ffb300; color: #333; }
        .metric-pill.conf { background: #8e24aa; }
        .metric-pill.runs { background: #0288d1; }
        .metric-pill.total-articles { background: #009688; }
        .metric-pill.total-recs { background: #1565c0; }
        .metric-pill.total-buy { background: #7cb342; }
        .metric-pill.total-sell { background: #c62828; }
        .ws-symbol-price { display: flex; align-items: center; gap: 0.5em; margin-right: 0.7em; }
        .ws-symbol-price .ws-symbol { margin-right: 0.2em; }
        .tooltip { position: absolute; z-index: 10; background: #222; color: #fff; padding: 0.4em 0.7em; border-radius: 6px; font-size: 0.93em; pointer-events: none; opacity: 0; transition: opacity 0.15s; white-space: pre-line; max-width: 220px; }
        .scroll-arrow { position: absolute; left: 50%; transform: translateX(-50%); font-size: 2.2em; color: #333; opacity: 0.85; pointer-events: none; z-index: 10; animation: bounce 1.2s infinite; text-shadow: 0 2px 8px #fff, 0 0 8px #1976d2; filter: drop-shadow(0 0 6px #fff); }
        .scroll-arrow.down { bottom: 0.2em; }
        .scroll-arrow.up { top: 0.2em; animation-direction: reverse; }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(10px); } }
        .recs-col { flex: 1; background: #fff; border-radius: 8px; box-shadow: 0 1px 4px #0001; padding: 1rem; min-height: 400px; max-height: 600px; overflow-y: auto; position: relative; transition: background 0.2s; scrollbar-width: thin; scrollbar-color: #888 #f1f3f6; }
        .recs-col::-webkit-scrollbar { width: 8px; background: #f1f3f6; }
        .recs-col::-webkit-scrollbar-thumb { background: #bbb; border-radius: 6px; }
        .recs-col:hover::-webkit-scrollbar-thumb { background: #888; }
        .rec-card { background: #fff; border-radius: 6px; box-shadow: 0 1px 2px #0001; margin-bottom: 0.7em; padding: 0.7em 1em; border-left: 5px solid #4caf50; transition: background 0.2s, color 0.2s, border-left-color 0.2s; position: relative; opacity: 1; transform: translateY(0); }
        #sell-recs-list .rec-card { border-left-color: #e53935; }
        .rec-card.faded { border-left: 5px solid rgba(76,175,80,0.18); background: #fafbfa; color: #aaa; }
        #sell-recs-list .rec-card.faded { border-left: 5px solid rgba(229,57,53,0.18); background: #fbf9f9; }
        .rec-card.animate-in { animation: slideInUp 0.5s cubic-bezier(.4,2,.6,1); }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        .load-more-btn { display: block; margin: 0.7em auto 0 auto; padding: 0.5em 1.5em; border-radius: 6px; border: none; background: #1976d2; color: #fff; font-size: 1em; font-weight: 500; cursor: pointer; box-shadow: 0 1px 4px #0001; transition: background 0.18s; }
        .load-more-btn:hover { background: #1565c0; }
    </style>
</head>
<body>
    <div class="metrics-bar" id="metrics-bar">
        <div class="metric-box">
            <div class="metric-label">Active Strategies</div>
            <div class="metric-value" id="active-strategies">0/0</div>
        </div>
        <div class="metric-box">
            <div class="metric-label">Recs in Last Hour</div>
            <div class="metric-value" id="recs-last-hour">0</div>
        </div>
        <div class="metric-box">
            <div class="metric-label">Total Recommendations</div>
            <div class="metric-value" id="total-recommendations">0</div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">WebSocket Subscribed Symbols (Live)</div>
        <div class="ws-symbols" id="ws-symbols">Loading...</div>
    </div>

    <div class="section">
        <div class="section-title">Strategies</div>
        <div class="strategies-scroll" id="strategies-scroll">Loading...</div>
    </div>

    <div class="section">
        <div class="section-title">Trade Recommendations</div>
        <div class="recommendations-section">
            <div class="recs-col" id="buy-recs-col">
                <div class="recs-header">
                    <span class="recs-title">Buy Recommendations</span>
                    <select class="recs-filter" id="buy-strategy-filter"></select>
                </div>
                <div id="buy-recs-list"></div>
                <div class="loading" id="buy-recs-loading">Loading...</div>
            </div>
            <div class="recs-col" id="sell-recs-col">
                <div class="recs-header">
                    <span class="recs-title">Sell Recommendations</span>
                    <select class="recs-filter" id="sell-strategy-filter"></select>
                </div>
                <div id="sell-recs-list"></div>
                <div class="loading" id="sell-recs-loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
    // --- Utility Functions ---
    function formatNumber(num) {
        if (num === null || num === undefined) return 'N/A';
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }
    function formatPercent(num) {
        if (num === null || num === undefined) return 'N/A';
        return num.toFixed(1) + '%';
    }
    function formatDateTime(dt) {
        if (!dt) return 'Never';
        return new Date(dt).toLocaleString();
    }
    function getAgeMinutes(dt) {
        if (!dt) return 99999;
        return (Date.now() - new Date(dt).getTime()) / 60000;
    }
    // --- Metrics Bar ---
    async function updateMetricsBar() {
        const resp = await fetch('/api/dashboard-data');
        const data = await resp.json();
        const metrics = data.metrics || {};
        const strategies = data.strategies || [];
        document.getElementById('active-strategies').textContent =
            (strategies.filter(s => s.active).length) + '/' + strategies.length;
        document.getElementById('recs-last-hour').textContent = metrics.recommendations_last_hour || 0;
        document.getElementById('total-recommendations').textContent = metrics.total_recommendations || 0;
    }
    setInterval(updateMetricsBar, 30000);
    updateMetricsBar();
    // --- WebSocket Symbols with Prices ---
    async function updateWsSymbols() {
        const resp = await fetch('/api/ws-subscribed-symbols');
        const data = await resp.json();
        const priceResp = await fetch('/api/ws-subscribed-symbol-prices');
        const priceData = await priceResp.json();
        const el = document.getElementById('ws-symbols');
        if (data.symbols && data.symbols.length > 0) {
            el.innerHTML = data.symbols.map(s => {
                const price = priceData[s] && priceData[s].price !== undefined ? priceData[s].price : 'N/A';
                return `<span class="ws-symbol-price"><span class="ws-symbol">${s}</span><span style="color:#333;font-size:0.98em;">$${price}</span></span>`;
            }).join(' ');
        } else {
            el.innerHTML = '<span style="color:#888">No active subscriptions</span>';
        }
    }
    setInterval(updateWsSymbols, 10000);
    updateWsSymbols();
    // --- Tooltip logic ---
    function showTooltip(el, text) {
        let tooltip = document.getElementById('global-tooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'global-tooltip';
            tooltip.className = 'tooltip';
            document.body.appendChild(tooltip);
        }
        tooltip.textContent = text;
        tooltip.style.opacity = 1;
        function move(e) {
            tooltip.style.left = (e.pageX + 12) + 'px';
            tooltip.style.top = (e.pageY + 12) + 'px';
        }
        el.addEventListener('mousemove', move);
        el.addEventListener('mouseleave', () => {
            tooltip.style.opacity = 0;
            el.removeEventListener('mousemove', move);
        }, { once: true });
    }
    // --- Strategies ---
    function getRedGradient(idx, total) {
        // Use HSL for a smooth, non-white gradient, cutoff at 85% lightness
        const minL = 45, maxL = 85; // min/max lightness
        const l = minL + (maxL - minL) * (idx / Math.max(total-1,1));
        return `hsl(2, 75%, ${l}%)`;
    }
    function getBlueGradient(idx, total) {
        // 0: #1565c0, 1: #42a5f5, 2: #90caf9, 3: #bbdefb, 4: #e3f2fd, 5: #f5faff
        const blues = ["#1565c0", "#42a5f5", "#90caf9", "#bbdefb", "#e3f2fd", "#f5faff"];
        return blues[Math.min(idx, blues.length-1)];
    }
    async function updateStrategies() {
        const resp = await fetch('/api/strategy-status');
        const strategies = await resp.json();
        const scroll = document.getElementById('strategies-scroll');
        scroll.innerHTML = '';
        strategies.forEach(s => {
            const card = document.createElement('div');
            card.className = 'strategy-card';
            // Last hour metrics
            const lastHourMetrics = [
                { label: 'Recs', value: s.metrics?.hourly?.recommendations_generated ?? 0 },
                { label: 'Articles', value: s.metrics?.hourly?.articles_processed ?? 0 },
                { label: 'Buy', value: s.metrics?.hourly?.buy_signals ?? 0 },
                { label: 'Sell', value: s.metrics?.hourly?.sell_signals ?? 0 },
                { label: 'Success', value: (s.metrics?.hourly?.success_rate ?? 0) + '%' },
                { label: 'Avg Conf', value: s.metrics?.hourly?.avg_confidence ?? 0 }
            ];
            // All time metrics
            const allTimeMetrics = [
                { label: 'Runs', value: s.metrics?.total_runs ?? 0 },
                { label: 'Articles', value: s.metrics?.total_articles_processed ?? 0 },
                { label: 'Recs', value: s.metrics?.total_recommendations ?? 0 },
                { label: 'Buy', value: s.metrics?.total_buy_signals ?? 0 },
                { label: 'Sell', value: s.metrics?.total_sell_signals ?? 0 }
            ];
            card.innerHTML = `
                <div class="strategy-header">
                    <span class="strategy-name">${s.name}</span>
                    <button class="toggle-btn ${s.active ? 'active' : 'inactive'}" onclick="toggleStrategy('${s.name}', ${s.active})">
                        <span class="toggle-label">${s.active ? 'On' : 'Off'}</span>
                    </button>
                </div>
                <div class="strategy-description">${s.description}</div>
                <div class="metrics-section">
                    <div class="metrics-label">Last Hour</div>
                    <div class="metrics-scroll-box">
                        ${lastHourMetrics.map((m, i) => `<div class="metric-pill" style="background:${getRedGradient(i, lastHourMetrics.length)};color:${i>=3?'#333':'#fff'}">${m.label}: ${m.value}</div>`).join('')}
                    </div>
                    <div class="metrics-label">All Time</div>
                    <div class="metrics-scroll-box">
                        ${allTimeMetrics.map((m, i) => `<div class="metric-pill" style="background:${getBlueGradient(i, allTimeMetrics.length)};color:${i>=3?'#333':'#fff'}">${m.label}: ${m.value}</div>`).join('')}
                    </div>
                </div>
            `;
            scroll.appendChild(card);
        });
    }
    async function toggleStrategy(name, currentlyActive) {
        await fetch('/api/strategy-activation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, active: !currentlyActive })
        });
        updateStrategies();
        updateMetricsBar();
    }
    setInterval(updateStrategies, 30000);
    updateStrategies();
    // --- Recommendations Infinite Scroll ---
    let buyPage = 1, sellPage = 1, buyLoading = false, sellLoading = false;
    let buyStrategyFilter = '', sellStrategyFilter = '';
    let buyHasMore = true, sellHasMore = true;
    let buyLastCount = 0, sellLastCount = 0;
    function renderRecCard(r, faded) {
        const age = getAgeMinutes(r.created_at);
        return `<div class="rec-card ${r.action}${faded ? ' faded' : ''}">
            <div class="rec-symbol" onmouseenter="showTooltip(this, 'Stock symbol for this trade')">${r.symbol}</div>
            <span class="rec-confidence" onmouseenter="showTooltip(this, 'Model confidence in this recommendation')">(${(r.confidence*100).toFixed(1)}%)</span>
            <span class="rec-live-price" onmouseenter="showTooltip(this, 'Price at the time of recommendation')">$${r.live_price ?? 'N/A'}</span>
            <div class="rec-meta" onmouseenter="showTooltip(this, 'Strategy: ${r.strategy_name}\nTime: ${formatDateTime(r.created_at)}')">${r.strategy_name} &middot; ${formatDateTime(r.created_at)}</div>
            <div class="rec-reason">${r.reasoning}</div>
        </div>`;
    }
    function renderRecList(list, container, filter, type, cutoffIdx) {
        container.innerHTML = '';
        let faded = false;
        list.forEach((r, idx) => {
            if (filter && r.strategy_name !== filter) return;
            const age = getAgeMinutes(r.created_at);
            if (!faded && age > 60) {
                container.innerHTML += '<div class="rec-age-separator">Older than 1 hour</div>';
                faded = true;
            }
            container.innerHTML += renderRecCard(r, faded);
        });
    }
    async function loadRecs(type, page, filter) {
        const resp = await fetch(`/api/recommendations?page=${page}&filter=${type}` + (filter ? `&strategy=${filter}` : ''));
        return await resp.json();
    }
    function animateNewCards(listEl, prevCount) {
        const cards = listEl.querySelectorAll('.rec-card');
        for (let i = prevCount; i < cards.length; ++i) {
            cards[i].classList.add('animate-in');
            setTimeout(() => cards[i].classList.remove('animate-in'), 600);
        }
    }
    function showScrollArrows(colId, listId, hasMore) {
        const col = document.getElementById(colId);
        let downArrow = col.querySelector('.scroll-arrow.down');
        let upArrow = col.querySelector('.scroll-arrow.up');
        // Remove if present
        if (downArrow) downArrow.remove();
        if (upArrow) upArrow.remove();
        // Down arrow if more to load
        if (hasMore) {
            downArrow = document.createElement('div');
            downArrow.className = 'scroll-arrow down';
            downArrow.innerHTML = '&#8595;';
            col.appendChild(downArrow);
        }
        // Up arrow if not at top
        if (col.scrollTop > 0) {
            upArrow = document.createElement('div');
            upArrow.className = 'scroll-arrow up';
            upArrow.innerHTML = '&#8593;';
            col.appendChild(upArrow);
        }
    }
    async function updateBuyRecs(reset=false) {
        if (buyLoading) return;
        buyLoading = true;
        const listEl = document.getElementById('buy-recs-list');
        let prevCount = listEl.querySelectorAll('.rec-card').length;
        if (reset) { buyPage = 1; buyHasMore = true; buyLastCount = 0; listEl.innerHTML = ''; prevCount = 0; }
        document.getElementById('buy-recs-loading').style.display = '';
        const recs = await loadRecs('buy', buyPage, buyStrategyFilter);
        if (recs.length === 0 && buyPage === 1) listEl.innerHTML = '<div class="loading">No buy recommendations.</div>';
        if (recs.length > 0) {
            renderRecList(recs, listEl, buyStrategyFilter, 'buy');
            buyLastCount = recs.length;
            animateNewCards(listEl, prevCount);
        }
        document.getElementById('buy-recs-loading').style.display = 'none';
        buyLoading = false;
        if (recs.length < 10) buyHasMore = false;
        showScrollArrows('buy-recs-col', 'buy-recs-list', buyHasMore);
        // Show Load More button if hasMore
        let btn = document.getElementById('buy-load-more-btn');
        if (buyHasMore) {
            if (!btn) {
                btn = document.createElement('button');
                btn.id = 'buy-load-more-btn';
                btn.className = 'load-more-btn';
                btn.textContent = 'Load More';
                btn.onclick = async () => { buyPage++; await updateBuyRecs(); };
                listEl.parentNode.appendChild(btn);
            }
        } else if (btn) { btn.remove(); }
    }
    async function updateSellRecs(reset=false) {
        if (sellLoading) return;
        sellLoading = true;
        const listEl = document.getElementById('sell-recs-list');
        let prevCount = listEl.querySelectorAll('.rec-card').length;
        if (reset) { sellPage = 1; sellHasMore = true; sellLastCount = 0; listEl.innerHTML = ''; prevCount = 0; }
        document.getElementById('sell-recs-loading').style.display = '';
        const recs = await loadRecs('sell', sellPage, sellStrategyFilter);
        if (recs.length === 0 && sellPage === 1) listEl.innerHTML = '<div class="loading">No sell recommendations.</div>';
        if (recs.length > 0) {
            renderRecList(recs, listEl, sellStrategyFilter, 'sell');
            sellLastCount = recs.length;
            animateNewCards(listEl, prevCount);
        }
        document.getElementById('sell-recs-loading').style.display = 'none';
        sellLoading = false;
        if (recs.length < 10) sellHasMore = false;
        showScrollArrows('sell-recs-col', 'sell-recs-list', sellHasMore);
        // Show Load More button if hasMore
        let btn = document.getElementById('sell-load-more-btn');
        if (sellHasMore) {
            if (!btn) {
                btn = document.createElement('button');
                btn.id = 'sell-load-more-btn';
                btn.className = 'load-more-btn';
                btn.textContent = 'Load More';
                btn.onclick = async () => { sellPage++; await updateSellRecs(); };
                listEl.parentNode.appendChild(btn);
            }
        } else if (btn) { btn.remove(); }
    }
    document.getElementById('buy-strategy-filter').onchange = function() {
        buyStrategyFilter = this.value;
        updateBuyRecs(true);
    };
    document.getElementById('sell-strategy-filter').onchange = function() {
        sellStrategyFilter = this.value;
        updateSellRecs(true);
    };
    // Populate strategy filters
    async function populateStrategyFilters() {
        const resp = await fetch('/api/strategy-status');
        const strategies = await resp.json();
        const buyFilter = document.getElementById('buy-strategy-filter');
        const sellFilter = document.getElementById('sell-strategy-filter');
        buyFilter.innerHTML = '<option value="">All Strategies</option>' + strategies.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        sellFilter.innerHTML = '<option value="">All Strategies</option>' + strategies.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
    }
    populateStrategyFilters();
    // Initial load
    updateBuyRecs(true);
    updateSellRecs(true);
    </script>
</body>
</html> 