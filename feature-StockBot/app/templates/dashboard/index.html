<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>StockBot Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #fbbf24;
            --info: #06b6d4;
            --bg: #f8fafc;
            --card-bg: rgba(255,255,255,0.85);
            --border: #e5e7eb;
            --text: #1e293b;
            --muted: #64748b;
            --accent: #fbbf24;
        }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Inter', Arial, sans-serif; background: var(--bg); color: var(--text); }
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 2vw;
        }
        .section {
            margin-bottom: 2.5rem;
            background: var(--card-bg);
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(30,41,59,0.07);
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            border: 1px solid var(--border);
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.2rem;
            color: var(--primary);
            letter-spacing: 0.5px;
        }
        .metrics-cards {
            display: flex;
            flex-direction: row;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 0.5rem 0.5rem 0.5rem 0.5rem;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            scrollbar-width: thin;
            border-radius: 12px;
            background: rgba(255,255,255,0.7);
        }
        .metrics-cards::-webkit-scrollbar {
            height: 8px;
        }
        .metrics-cards::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 8px;
        }
        .card {
            min-width: 170px;
            max-width: 200px;
            height: 60px;
            border-radius: 8px;
            padding: 0.7rem 1rem;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 0 1px 4px rgba(30,41,59,0.07);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            border: 1.5px solid var(--border);
            transition: box-shadow 0.15s;
            justify-content: center;
            margin: 0;
        }
        .card span {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 0.2rem;
        }
        .card.metric-portfolio { background: linear-gradient(90deg, #3b82f6cc, #60a5facc); color: #fff; }
        .card.metric-pnl { background: linear-gradient(90deg, #22c55ecc, #4ade80cc); color: #fff; }
        .card.metric-users { background: linear-gradient(90deg, #a78bfa99, #818cf8cc); color: #fff; }
        .card.metric-trades { background: linear-gradient(90deg, #fbbf24cc, #fde68acc); color: #fff; }
        .card.metric-alloc { background: linear-gradient(90deg, #06b6d4cc, #67e8f9cc); color: #fff; }
        .card.metric-executed { background: linear-gradient(90deg, #22c55ecc, #38bdf8cc); color: #fff; }
        .card.metric-pending { background: linear-gradient(90deg, #fbbf24cc, #facc15cc); color: #fff; }
        .card.metric-expired { background: linear-gradient(90deg, #64748bcc, #a1a1aa); color: #fff; }
        .card.metric-failed { background: linear-gradient(90deg, #ef4444cc, #f87171cc); color: #fff; }
        .card.metric-totalusers { background: linear-gradient(90deg, #06b6d4cc, #818cf8cc); color: #fff; }
        .card.metric-acceptance { background: linear-gradient(90deg, #38bdf8cc, #4ade80cc); color: #fff; }
        .card.metric-time { background: linear-gradient(90deg, #fbbf24cc, #fcd34dcc); color: #fff; }
        .card.metric-size { background: linear-gradient(90deg, #818cf8cc, #a78bfa99); color: #fff; }
        .card.metric-exec { background: linear-gradient(90deg, #f87171cc, #fbbf24cc); color: #fff; }
        .card.metric-cur { background: linear-gradient(90deg, #60a5facc, #38bdf8cc); color: #fff; }
        .filter-bar {
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            background: rgba(59,130,246,0.07);
            border-radius: 8px;
            padding: 0.7rem 1rem;
        }
        .search-box {
            padding: 0.5rem 1rem 0.5rem 2.2rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: #f1f5f9 url('data:image/svg+xml;utf8,<svg fill="%2364748b" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99a1 1 0 001.41-1.41l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>') no-repeat 0.7rem center;
            color: var(--text);
        }
        .filter-bar select, .filter-bar input[type="date"] {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #f1f5f9;
            color: var(--text);
            font-size: 1rem;
            margin-right: 0.2rem;
        }
        .filter-bar input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }
        .filter-bar button {
            padding: 0.5rem 1.2rem;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.15s;
        }
        .filter-bar button:hover {
            background: var(--primary-light);
        }
        .scroll-table-wrapper {
            max-height: 320px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #f9fafb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.98rem;
        }
        th, td {
            padding: 0.7rem 0.5rem;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }
        th {
            background: #f1f5f9;
            color: var(--muted);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr.user-row { cursor: pointer; transition: background 0.13s; }
        tr.user-row:hover { background: #e0e7ef; }
        tr:hover { background: #f3f4f6; }
        .popup {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(30,41,59,0.18);
            padding: 2.5rem 2rem;
            z-index: 1000;
            min-width: 350px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }
        .popup.active { display: block; }
        .popup-close {
            float: right;
            cursor: pointer;
            color: var(--muted);
            font-size: 1.5rem;
            font-weight: 700;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(30,41,59,0.18);
            z-index: 999;
        }
        .overlay.active { display: block; }
        @media (max-width: 900px) {
            main { padding: 1rem 2vw; }
            .metrics-cards { flex-direction: column; gap: 1rem; }
            .section { padding: 1rem 0.5rem; }
        }
        @media (max-width: 600px) {
            .metrics-cards { flex-direction: column; gap: 1rem; }
            .section { padding: 1rem 0.5rem; }
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <main>
        <section id="metrics-cards" class="metrics-cards section">
            <div class="card metric-portfolio">Portfolio Value <span id="portfolio-value">$0.00</span></div>
            <div class="card metric-pnl">P&amp;L <span id="pnl">$0.00</span></div>
            <div class="card metric-users">Active Users <span id="active-users">0</span></div>
            <div class="card metric-trades">Total Trades <span id="total-trades">0</span></div>
            <div class="card metric-alloc">Total Allocations <span id="total-allocations">$0.00</span></div>
            <div class="card metric-executed">Executed Trades <span id="executed-trades">0</span></div>
            <div class="card metric-pending">Pending Trades <span id="pending-trades">0</span></div>
            <div class="card metric-expired">Expired Trades <span id="expired-trades">0</span></div>
            <div class="card metric-failed">Failed Trades <span id="failed-trades">0</span></div>
            <div class="card metric-totalusers">Total Users <span id="total-users">0</span></div>
            <div class="card metric-acceptance">Acceptance Rate <span id="acceptance-rate">0%</span></div>
            <div class="card metric-time">Avg Acceptance Time <span id="avg-acceptance-time">0s</span></div>
            <div class="card metric-size">Avg Trade Size <span id="avg-trade-size">$0</span></div>
            <div class="card metric-exec">Avg Execution Time <span id="avg-execution-time">0s</span></div>
            <div class="card metric-cur">Current Acceptances <span id="current-acceptances">0</span></div>
        </section>
        <section id="user-search" class="section">
            <div class="section-title">User Search &amp; Leaderboard</div>
            <div class="filter-bar">
                <input class="search-box" type="text" id="user-search-box" placeholder="Search users...">
                <select id="user-sort">
                    <option value="equity">Sort by Equity</option>
                    <option value="pnl">Sort by P&L</option>
                    <option value="username">Sort by Username</option>
                </select>
                <select id="user-pnl-filter">
                    <option value="all">All</option>
                    <option value="positive">Positive P&L</option>
                    <option value="negative">Negative P&L</option>
                </select>
                <span id="user-count"></span>
            </div>
            <div class="scroll-table-wrapper">
                <table class="leaderboard">
                    <thead><tr><th>Username</th><th>Equity</th><th>P&amp;L</th></tr></thead>
                    <tbody id="leaderboard-body"></tbody>
                </table>
            </div>
            <div id="user-empty-msg" style="color:#888;text-align:center;display:none;">No users found.</div>
            <div class="filter-bar">
                <button id="user-prev-page">&lt; Prev</button>
                <span id="user-page-info"></span>
                <button id="user-next-page">Next &gt;</button>
            </div>
        </section>
        <section id="trade-summary" class="section">
            <div class="section-title">Trade Recommendation Stats</div>
            <div class="metrics-cards" id="trade-summary-stats">
                <!-- Optionally, add summary stats for trades here -->
            </div>
            <div class="filter-bar">
                <input class="search-box" type="text" id="trade-search-box" placeholder="Search symbol...">
                <select id="trade-status-filter">
                    <option value="">All Statuses</option>
                    <option value="PENDING">Pending</option>
                    <option value="EXECUTED">Executed</option>
                    <option value="EXPIRED">Expired</option>
                </select>
                <input type="date" id="trade-start-date">
                <input type="date" id="trade-end-date">
                <span id="trade-count"></span>
            </div>
            <div class="scroll-table-wrapper">
                <table class="trades-table">
                    <thead><tr><th>Symbol</th><th>Strategy</th><th>Price</th><th>Type</th><th>Status</th><th>Users</th><th>Brokerage Trade</th><th>Created</th><th>Expired At</th></tr></thead>
                    <tbody id="trades-body"></tbody>
                </table>
            </div>
            <div id="trades-empty-msg" style="color:#888;text-align:center;display:none;">No trades found.</div>
            <div class="filter-bar">
                <button id="trades-prev-page">&lt; Prev</button>
                <span id="trades-page-info"></span>
                <button id="trades-next-page">Next &gt;</button>
            </div>
        </section>
        <section id="orders-section" class="section">
            <div class="section-title">Live Orders</div>
            <div class="filter-bar">
                <input class="search-box" type="text" id="orders-symbol-search" placeholder="Symbol...">
                <select id="orders-status-filter">
                    <option value="">All Statuses</option>
                    <option value="new">New</option>
                    <option value="partially_filled">Partially Filled</option>
                    <option value="filled">Filled</option>
                    <option value="done_for_day">Done for Day</option>
                    <option value="canceled">Canceled</option>
                    <option value="expired">Expired</option>
                    <option value="replaced">Replaced</option>
                    <option value="pending_cancel">Pending Cancel</option>
                    <option value="pending_replace">Pending Replace</option>
                    <option value="stopped">Stopped</option>
                    <option value="rejected">Rejected</option>
                    <option value="pending_new">Pending New</option>
                    <option value="accepted">Accepted</option>
                </select>
                <span id="orders-count"></span>
            </div>
            <div class="scroll-table-wrapper">
                <table class="orders-table">
                    <thead><tr><th>Symbol</th><th>Qty</th><th>Side</th><th>Status</th><th>Avg Price</th><th>Submitted</th></tr></thead>
                    <tbody id="orders-body"></tbody>
                </table>
            </div>
            <div id="orders-empty-msg" style="color:#888;text-align:center;display:none;">No orders found.</div>
            <div class="filter-bar">
                <button id="orders-prev-page">&lt; Prev</button>
                <span id="orders-page-info"></span>
                <button id="orders-next-page">Next &gt;</button>
            </div>
        </section>
        <section id="logs-section" class="section">
            <div class="section-title">Logs &amp; Monitoring</div>
            <div class="filter-bar">
                <select id="logs-event-filter">
                    <option value="">All Events</option>
                    <option value="EXECUTED">Executed</option>
                    <option value="FAILED">Failed</option>
                    <option value="EXPIRED">Expired</option>
                </select>
                <input type="date" id="logs-start-date">
                <input type="date" id="logs-end-date">
                <span id="logs-count"></span>
            </div>
            <div class="scroll-table-wrapper">
                <table class="logs-table">
                    <thead><tr><th>Timestamp</th><th>Event</th><th>Details</th><th>Trade ID</th></tr></thead>
                    <tbody id="logs-body"></tbody>
                </table>
            </div>
            <div id="logs-empty-msg" style="color:#888;text-align:center;display:none;">No logs found.</div>
            <div class="filter-bar">
                <button id="logs-prev-page">&lt; Prev</button>
                <span id="logs-page-info"></span>
                <button id="logs-next-page">Next &gt;</button>
            </div>
        </section>
        <section id="trade-acceptances-section" class="section">
            <div class="section-title">User Acceptances & Allocations (Latest Trade)</div>
            <table class="acceptances-table">
                <thead><tr><th>User ID</th><th>Allocation ($)</th><th>Allocation (Shares)</th><th>Status</th><th>Updated At</th></tr></thead>
                <tbody id="acceptances-body"></tbody>
            </table>
        </section>
        <section id="brokerage-section" class="section">
            <div class="section-title">Brokerage-Wide Positions</div>
            <table class="leaderboard">
                <thead><tr><th>Symbol</th><th>Total Shares</th><th>Avg Price</th><th>Current Price</th><th>Total Value</th><th>Unrealized P&L</th></tr></thead>
                <tbody id="brokerage-positions-body"></tbody>
            </table>
            <div class="section-title">Brokerage Portfolio History</div>
            <table class="leaderboard">
                <thead><tr><th>Symbol</th><th>Total Shares</th><th>Avg Price</th><th>Market Price</th><th>Total Value</th><th>Unrealized P&L</th><th>Recorded At</th></tr></thead>
                <tbody id="brokerage-history-body"></tbody>
            </table>
            <canvas id="brokerage-portfolio-graph" height="100"></canvas>
        </section>
    </main>
</div>
<div class="overlay" id="popup-overlay"></div>
<div class="popup" id="user-popup">
    <span class="popup-close" onclick="closePopup()">&times;</span>
    <div id="popup-content">User details will appear here.</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let userPage = 1;
    let userPerPage = 20;
    let userTotal = 0;
    // Fetch metrics and update dashboard cards
    function updateMetrics() {
        fetch('/api/metrics')
            .then(res => res.json())
            .then(data => {
                document.getElementById('portfolio-value').textContent = `$${data.portfolio_value.toLocaleString()}`;
                document.getElementById('pnl').textContent = `$${data.pnl.toLocaleString()}`;
                document.getElementById('active-users').textContent = data.active_users;
                document.getElementById('total-trades').textContent = data.total_trades;
                document.getElementById('total-allocations').textContent = `$${data.total_allocations.toLocaleString()}`;
                document.getElementById('executed-trades').textContent = data.executed_trades;
                document.getElementById('pending-trades').textContent = data.pending_trades;
                document.getElementById('expired-trades').textContent = data.expired_trades;
                document.getElementById('failed-trades').textContent = data.failed_trades;
                document.getElementById('total-users').textContent = data.total_users;
                // New metrics
                document.getElementById('acceptance-rate').textContent = `${data.acceptance_rate}%`;
                document.getElementById('avg-acceptance-time').textContent = `${data.avg_acceptance_time}s`;
                document.getElementById('avg-trade-size').textContent = `$${data.avg_trade_size.toLocaleString()}`;
                document.getElementById('avg-execution-time').textContent = `${data.avg_execution_time}s`;
                document.getElementById('current-acceptances').textContent = data.current_acceptances;
            });
    }
    updateMetrics();
    setInterval(updateMetrics, 30000);

    // Fetch users and populate leaderboard
    function updateUsers(search = '', sort = 'equity', pnlFilter = 'all', page = 1) {
        fetch(`/api/users?search=${encodeURIComponent(search)}&sort=${sort}&pnl_filter=${pnlFilter}&page=${page}&per_page=${userPerPage}`)
            .then(res => res.json())
            .then(data => {
                const users = data.users || [];
                userTotal = data.total || 0;
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = '';
                if (users.length === 0) {
                    document.getElementById('user-empty-msg').style.display = 'block';
                } else {
                    document.getElementById('user-empty-msg').style.display = 'none';
                    users.forEach(u => {
                        const tr = document.createElement('tr');
                        tr.className = 'user-row';
                        tr.innerHTML = `<td>${u.username}</td><td>$${u.equity.toLocaleString()}</td><td>$${u.pnl.toLocaleString()}</td>`;
                        tr.onclick = function() { openPopup('User: ' + u.username, u.id); };
                        tbody.appendChild(tr);
                    });
                }
                document.getElementById('user-count').textContent = `Total: ${userTotal}`;
                document.getElementById('user-page-info').textContent = `Page ${userPage} of ${Math.ceil(userTotal/userPerPage)}`;
            });
    }
    document.getElementById('user-search-box').addEventListener('input', function() {
        userPage = 1;
        updateUsers(this.value, document.getElementById('user-sort').value, document.getElementById('user-pnl-filter').value, userPage);
    });
    document.getElementById('user-sort').addEventListener('change', function() {
        userPage = 1;
        updateUsers(document.getElementById('user-search-box').value, this.value, document.getElementById('user-pnl-filter').value, userPage);
    });
    document.getElementById('user-pnl-filter').addEventListener('change', function() {
        userPage = 1;
        updateUsers(document.getElementById('user-search-box').value, document.getElementById('user-sort').value, this.value, userPage);
    });
    document.getElementById('user-prev-page').addEventListener('click', function() {
        if (userPage > 1) {
            userPage--;
            updateUsers(document.getElementById('user-search-box').value, document.getElementById('user-sort').value, document.getElementById('user-pnl-filter').value, userPage);
        }
    });
    document.getElementById('user-next-page').addEventListener('click', function() {
        if (userPage < Math.ceil(userTotal/userPerPage)) {
            userPage++;
            updateUsers(document.getElementById('user-search-box').value, document.getElementById('user-sort').value, document.getElementById('user-pnl-filter').value, userPage);
        }
    });
    updateUsers();

    // Fetch trades and populate trade summary
    let tradesPage = 1;
    let tradesPerPage = 20;
    let tradesTotal = 0;
    async function updateTrades() {
        const search = document.getElementById('trade-search-box').value;
        const status = document.getElementById('trade-status-filter').value;
        const start = document.getElementById('trade-start-date').value;
        const end = document.getElementById('trade-end-date').value;
        let url = `/api/trades?search=${encodeURIComponent(search)}&status=${status}&start_date=${start}&end_date=${end}&page=${tradesPage}&per_page=${tradesPerPage}`;
        const res = await fetch(url);
        const data = await res.json();
        const trades = data.trades || [];
        tradesTotal = data.total || 0;
        const tbody = document.getElementById('trades-body');
        tbody.innerHTML = '';
        if (trades.length === 0) {
            document.getElementById('trades-empty-msg').style.display = 'block';
        } else {
            document.getElementById('trades-empty-msg').style.display = 'none';
            for (const t of trades) {
                const tr = document.createElement('tr');
                // Status badge
                let statusClass = 'badge-pending';
                if (t.status === 'EXECUTED') statusClass = 'badge-executed';
                else if (t.status === 'EXPIRED') statusClass = 'badge-expired';
                // Users button
                const usersBtn = `<button class="users-btn" data-tradeid="${t.id}" data-users="${t.users}">${t.users}</button>`;
                // Brokerage trade (from API)
                let brokerageTrade = t.brokerage_trade || '';
                // Price column
                let price = t.price !== null && t.price !== undefined ? `$${parseFloat(t.price).toFixed(2)}` : '';
                // Strategy column
                let strategy = t.strategy_name || '';
                tr.innerHTML = `<td>${t.symbol}</td><td>${strategy}</td><td>${price}</td><td>${t.type}</td><td><span class="status-badge ${statusClass}">${t.status}</span></td><td>${usersBtn}</td><td>${brokerageTrade}</td><td>${t.created_at}</td><td>${t.expired_at || ''}</td>`;
                tbody.appendChild(tr);
            }
        }
        document.getElementById('trade-count').textContent = `Total: ${tradesTotal}`;
        document.getElementById('trades-page-info').textContent = `Page ${tradesPage} of ${Math.ceil(tradesTotal/tradesPerPage)}`;
        // Add event listeners for users buttons
        document.querySelectorAll('.users-btn').forEach(btn => {
            btn.onclick = function() {
                const tradeId = this.getAttribute('data-tradeid');
                openTradeUsersPopup(tradeId);
            };
        });
    }
    async function openTradeUsersPopup(tradeId) {
        // Fetch acceptances for this trade
        const res = await fetch(`/api/trade_acceptances?trade_id=${tradeId}`);
        const acceptances = await res.json();
        let html = `<h3>Users Accepted Trade #${tradeId}</h3><ul>`;
        if (acceptances.length === 0) html += '<li>No users have accepted this trade.</li>';
        else acceptances.forEach(a => {
            html += `<li><b>${a.username || a.user_id}</b>: $${a.allocation_amount || 0} (${a.allocation_shares || 0} shares)</li>`;
        });
        html += '</ul>';
        document.getElementById('popup-content').innerHTML = html;
        document.getElementById('user-popup').classList.add('active');
        document.getElementById('popup-overlay').classList.add('active');
    }
    document.getElementById('trade-search-box').addEventListener('input', function() { tradesPage = 1; updateTrades(); });
    document.getElementById('trade-status-filter').addEventListener('change', function() { tradesPage = 1; updateTrades(); });
    document.getElementById('trade-start-date').addEventListener('change', function() { tradesPage = 1; updateTrades(); });
    document.getElementById('trade-end-date').addEventListener('change', function() { tradesPage = 1; updateTrades(); });
    document.getElementById('trades-prev-page').addEventListener('click', function() { if (tradesPage > 1) { tradesPage--; updateTrades(); } });
    document.getElementById('trades-next-page').addEventListener('click', function() { if (tradesPage < Math.ceil(tradesTotal/tradesPerPage)) { tradesPage++; updateTrades(); } });
    updateTrades();
    setInterval(updateTrades, 120000); // Refresh every 2 minutes

    // Fetch orders and populate live orders table
    let ordersPage = 1;
    let ordersPerPage = 20;
    let ordersTotal = 0;
    function updateOrders() {
        const symbol = document.getElementById('orders-symbol-search').value;
        const status = document.getElementById('orders-status-filter').value;
        let url = `/api/orders?symbol=${encodeURIComponent(symbol)}&status=${status}&page=${ordersPage}&per_page=${ordersPerPage}`;
        fetch(url)
            .then(res => res.json())
            .then(data => {
                const orders = data.orders || [];
                ordersTotal = data.total || 0;
                const tbody = document.getElementById('orders-body');
                tbody.innerHTML = '';
                if (orders.length === 0) {
                    document.getElementById('orders-empty-msg').style.display = 'block';
                } else {
                    document.getElementById('orders-empty-msg').style.display = 'none';
                    orders.forEach(o => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${o.symbol}</td><td>${o.qty}</td><td>${o.side}</td><td>${o.status}</td><td>${o.filled_avg_price || '-'}</td><td>${o.submitted_at}</td>`;
                        tbody.appendChild(tr);
                    });
                }
                document.getElementById('orders-count').textContent = `Total: ${ordersTotal}`;
                document.getElementById('orders-page-info').textContent = `Page ${ordersPage} of ${Math.ceil(ordersTotal/ordersPerPage)}`;
            });
    }
    document.getElementById('orders-symbol-search').addEventListener('input', function() { ordersPage = 1; updateOrders(); });
    document.getElementById('orders-status-filter').addEventListener('change', function() { ordersPage = 1; updateOrders(); });
    document.getElementById('orders-prev-page').addEventListener('click', function() { if (ordersPage > 1) { ordersPage--; updateOrders(); } });
    document.getElementById('orders-next-page').addEventListener('click', function() { if (ordersPage < Math.ceil(ordersTotal/ordersPerPage)) { ordersPage++; updateOrders(); } });
    updateOrders();

    // Fetch logs and populate logs table
    let logsPage = 1;
    let logsPerPage = 20;
    let logsTotal = 0;
    function updateLogs() {
        const event = document.getElementById('logs-event-filter').value;
        const start = document.getElementById('logs-start-date').value;
        const end = document.getElementById('logs-end-date').value;
        let url = `/api/logs?event=${event}&start_date=${start}&end_date=${end}&page=${logsPage}&per_page=${logsPerPage}`;
        fetch(url)
            .then(res => res.json())
            .then(data => {
                const logs = data.logs || [];
                logsTotal = data.total || 0;
                const tbody = document.getElementById('logs-body');
                tbody.innerHTML = '';
                if (logs.length === 0) {
                    document.getElementById('logs-empty-msg').style.display = 'block';
                } else {
                    document.getElementById('logs-empty-msg').style.display = 'none';
                    logs.forEach(l => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${l.timestamp}</td><td>${l.event}</td><td>${l.details}</td><td>${l.trade_recommendation_id}</td>`;
                        tbody.appendChild(tr);
                    });
                }
                document.getElementById('logs-count').textContent = `Total: ${logsTotal}`;
                document.getElementById('logs-page-info').textContent = `Page ${logsPage} of ${Math.ceil(logsTotal/logsPerPage)}`;
            });
    }
    document.getElementById('logs-event-filter').addEventListener('change', function() { logsPage = 1; updateLogs(); });
    document.getElementById('logs-start-date').addEventListener('change', function() { logsPage = 1; updateLogs(); });
    document.getElementById('logs-end-date').addEventListener('change', function() { logsPage = 1; updateLogs(); });
    document.getElementById('logs-prev-page').addEventListener('click', function() { if (logsPage > 1) { logsPage--; updateLogs(); } });
    document.getElementById('logs-next-page').addEventListener('click', function() { if (logsPage < Math.ceil(logsTotal/logsPerPage)) { logsPage++; updateLogs(); } });
    updateLogs();

    // Fetch and display user acceptances for the latest trade recommendation
    function updateAcceptances() {
        fetch('/api/latest_trade_recommendation')
            .then(res => res.json())
            .then(trade => {
                if (!trade.id) return;
                fetch('/api/trade_acceptances?trade_id=' + trade.id)
                    .then(res => res.json())
                    .then(acceptances => {
                        const tbody = document.getElementById('acceptances-body');
                        tbody.innerHTML = '';
                        if (acceptances.length === 0) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td colspan="5" style="text-align:center;color:#888;">No user acceptances yet</td>`;
                            tbody.appendChild(tr);
                        } else {
                            acceptances.forEach(a => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td>${a.user_id}</td><td>${a.allocation_amount || '-'}</td><td>${a.allocation_shares || '-'}</td><td>${a.status}</td><td>${a.updated_at}</td>`;
                                tbody.appendChild(tr);
                            });
                        }
                    });
            });
    }
    updateAcceptances();
    setInterval(updateAcceptances, 30000);

    // Brokerage-wide positions
    function updateBrokeragePositions() {
        fetch('/api/brokerage/positions')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('brokerage-positions-body');
                tbody.innerHTML = '';
                data.forEach(pos => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${pos.symbol}</td><td>${pos.total_shares}</td><td>${pos.average_price}</td><td>${pos.current_price}</td><td>${pos.total_value}</td><td>${pos.unrealized_pnl}</td>`;
                    tbody.appendChild(tr);
                });
            });
    }
    function updateBrokerageHistory() {
        fetch('/api/brokerage/history')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('brokerage-history-body');
                tbody.innerHTML = '';
                let graphData = {};
                let pnlData = {};
                data.forEach(hist => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${hist.symbol}</td><td>${hist.shares_owned}</td><td>${hist.average_price}</td><td>${hist.market_price}</td><td>${hist.total_value}</td><td>${hist.unrealized_pnl}</td><td>${hist.recorded_at}</td>`;
                    tbody.appendChild(tr);
                    // Prepare data for graph
                    if (!graphData[hist.symbol]) graphData[hist.symbol] = {labels: [], values: []};
                    graphData[hist.symbol].labels.push(hist.recorded_at);
                    graphData[hist.symbol].values.push(hist.total_value);
                    if (!pnlData[hist.symbol]) pnlData[hist.symbol] = {labels: [], values: []};
                    pnlData[hist.symbol].labels.push(hist.recorded_at);
                    pnlData[hist.symbol].values.push(hist.unrealized_pnl);
                });
                // Draw graph for first symbol (or all, if desired)
                const ctx = document.getElementById('brokerage-portfolio-graph').getContext('2d');
                if (Object.keys(graphData).length > 0) {
                    const firstSymbol = Object.keys(graphData)[0];
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: graphData[firstSymbol].labels,
                            datasets: [
                                {
                                    label: firstSymbol + ' Portfolio Value',
                                    data: graphData[firstSymbol].values,
                                    borderColor: 'rgba(75,192,192,1)',
                                    fill: false
                                },
                                {
                                    label: firstSymbol + ' P&L',
                                    data: pnlData[firstSymbol].values,
                                    borderColor: 'rgba(255,99,132,1)',
                                    fill: false
                                }
                            ]
                        },
                        options: {scales: {x: {display: true}, y: {display: true}}}
                    });
                }
            });
    }
    updateBrokeragePositions();
    updateBrokerageHistory();
    setInterval(updateBrokeragePositions, 30000);
    setInterval(updateBrokerageHistory, 30000);

    // Popup logic
    function openPopup(content, userId) {
        document.getElementById('popup-content').innerHTML = content;
        document.getElementById('user-popup').classList.add('active');
        document.getElementById('popup-overlay').classList.add('active');
        if (userId) {
            // Fetch and show user positions and history
            fetch(`/api/user/${userId}/positions`).then(res => res.json()).then(pos => {
                let html = '<h4>User Positions</h4><ul>';
                if (pos.length === 0) html += '<li>No positions</li>';
                pos.forEach(p => { html += `<li>${p.symbol}: ${p.shares_owned} @ $${p.average_buy_price} (Value: $${p.market_value})</li>`; });
                html += '</ul>';
                document.getElementById('popup-content').innerHTML += html;
            });
            fetch(`/api/user/${userId}/history`).then(res => res.json()).then(hist => {
                let html = '<h4>User History</h4><ul>';
                if (hist.length === 0) html += '<li>No history</li>';
                hist.forEach(h => { html += `<li>${h.recorded_at}: ${h.symbol} - ${h.shares_owned} @ $${h.average_price} (Value: $${h.total_value})</li>`; });
                html += '</ul>';
                document.getElementById('popup-content').innerHTML += html;
            });
            fetch(`/api/failed_trades?user_id=${userId}`).then(res => res.json()).then(fails => {
                let html = '<h4>Failed Trades</h4><ul>';
                if (fails.length === 0) html += '<li>No failed trades</li>';
                fails.forEach(f => { html += `<li>${f.failed_at}: Trade ${f.trade_recommendation_id} - ${f.reason}</li>`; });
                html += '</ul>';
                document.getElementById('popup-content').innerHTML += html;
            });
        }
    }
    function closePopup() {
        document.getElementById('user-popup').classList.remove('active');
        document.getElementById('popup-overlay').classList.remove('active');
    }
    document.getElementById('popup-overlay').onclick = closePopup;

    // Modern sidebar navigation
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            navLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            const section = document.querySelector(this.getAttribute('href'));
            if (section) section.scrollIntoView({behavior: 'smooth'});
        });
    });
</script>
</body>
</html> 